---
title: "Building Your Predictive Model"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

In this R notebook, we're going to learn the basics of predictive modeling. 

## What is an R Notebook?

An R Notebook is a way to run R code and save the output (such as graphs and tables) in the same document. Make sure that you have opened the project file (`shhs_workshop.rproj`) in RStudio before you do anything. This will set you up so R knows where the data is.

There are two main formats for a R Notebook. The first are known as the markdown chunks, which are mostly text. The other format is the code chunk, which is started by the three backticks (\`\`\`) and a `{r}`, such as the code block below. Usually, we want the code block to give us an output, such as a table or a graph. However, the code isn't run until we hit the play button. This is really important to know. 

R Notebooks are presented two ways: as an editable document (which is what you have here), and a preview document. You will be able to see the preview document by hitting the `Preview` button.

## Important!

Be sure to go slowly through the notebook slowly and read the code. If you just press play without reading and understanding the code, you will miss out on the learning! Talk about the code blocks with your group partner.

## Getting Help

If you're confused about a function, such as `head`, you can run `?head` (adding a question mark to the beginning of the function) to get help about that function. Try running the command below by hitting the play button. The help window for the function should open on the right.

```{r}
?head
```

## First Things First

The first thing to do is to load the data into your workspace. Click the `play` button on the below code chunk. We first load in some packages: `broom`, `tidyr`, `dplyr`, and `visdat`. Then we're going to load our data using the `read_rds` function. We use the `<-` to *assign* our data into the `shhs_data` object. 

```{r setup}
library(broom)
library(tidyr)
library(dplyr)
library(visdat)

shhs_data <- readRDS("data/common_data_small.rds")
```

Look at your `environment` tab and click on the `shhs_data` line. You will be able to see a spreadsheet like view of the data.

## Show the first few rows of the data

Let's look at the first few rows of the data with the `head()` command. The head command will show the first few rows.

```{r}
head(shhs_data)
```

## Including an image from our Data Explorer

You can add an image by using what's called a markdown tag into this document. For example, if I wanted to add the image in our `images` folder called `sample_image.png`, you use this little bit of code:

![Overview of Data](images/sample_image.png)

Unfortunately, the image doesn't pop-up when we're editing the notebook, but it will when we hit the "Preview" button on the notebook bar above. Try it out!

## Data Wrangling 101: Select our covariates

Ok, now we're going to build a simple predictive model with our covariates. We're going to use the `select` function in the `dplyr` package to pick our variables. This is important to do beforehand because we're going to select the complete cases in our data to model.

This will seem weird at first, but the `%>%` is what's called a `pipe` and lets us flow our data from one function to another. 

Think about it: which variables are we selecting? What is our outcome we're trying to predict?

```{r}
shhs_data_model <- shhs_data %>% select(any_cvd, age_s1, gender, bmi_s1)

head(shhs_data_model)
```

We're going to use `visdat` to summarize our data again. What do you notice in our dataset?

```{r}
visdat::vis_dat(shhs_data_model)
```

## What are you going to do about `NA`s?

Ugh. There are NAs in our data! We're going to use the `drop_na` function to remove all rows that are not complete. 

```{r}
shhs_data_model_filtered <- shhs_data_model %>% tidyr::drop_na()

visdat::vis_dat(shhs_data_model_filtered)
```

## Separating out our data

Ok, now we have to separate our data into two sets: the *training* set and the *test* set.

1. Training set: a set of data with which we build (or train) our model with. 
2. Test set: a set of data with which we test the predictive power of our model.

```{r}
shhs_train_index <- caret::createDataPartition(shhs_data_model_filtered$any_cvd, p=0.85, list=FALSE)
shhs_train_data <- shhs_data_model_filtered[shhs_train_index,]
shhs_test_data <- shhs_data_model_filtered[-shhs_train_index,]

```

```{r}
nrow(shhs_train_data)
```

```{r}
nrow(shhs_test_data)
```

## A Basic Model

Here we're going to build a basic model with `any_cvd` as our outcome (what we want to predict), and 

```{r}
basic_model <- glm(#put your formula below
                   formula = any_cvd ~ gender + age_s1 + bmi_s1, 
                   # binomial
                   family = "binomial", 
                   #we put our data into the data argument
                   data =    shhs_train_data
                   )
```

Show the coefficients of the model with the `tidy` function from `broom`. Each row of this is a predictor in our model, and we focus on two columns. 

```{r}
glance(basic_model)
```

```{r}
tidy(basic_model)
```

```{r}
predictions <- augment(basic_model, newdata = shhs_test_data, type.predict = "response")
predictions
predictions %>% ggplot(aes(x=.fitted)) + geom_histogram()
```